@using Focus8W.Models
@using SchoolBones
@model IdNamePair[]

@{
    IdNamePair[] arrTeachers = Model;

    GLOBAL oGLOBAL = new GLOBAL();
    int iRegId = oGLOBAL.RegId;
}

<style>
    li:focus {
  background: white;
}
</style>

<form action="/action_page.php" class="form-container">
    <h3>Chat</h3>
    <div class="row">

        <div class="col-md-3">
            @{
                if (arrTeachers != null)
                {
                    <ul>
                        @for (int iTech = 0; iTech < arrTeachers.Length; iTech++)
                        {
                            <li tabindex="1">
                                <label class="form-label" onclick="LoadChat(@arrTeachers[iTech].ID)">@arrTeachers[iTech].Name</label>
                            </li>
                        }
                    </ul>
                   
                }
            }
        </div>
        <div class="col-md-9">
            <label for="msg"><b>Message</b></label>

            <div class="bg-secondary" style="height: 200px; width: 72%; margin-left: 0px;">
                <div id="dvChatArea" class="row">

                </div>
            </div>

            <input type="text" id="txtMessage" placeholder="Type message..." required class="text-bg-light" />

            <input type="button" class="btn-primary" value="Send" onclick="Send()" />
            <input type="button" class="btn-secondary" value="Close" onclick="closeForm()" />
        </div>
    </div>

</form>


<script>
    var iRegId = @Html.Raw(Json.Encode(iRegId));


    var iTo = -1;
    var dvChatArea = document.getElementById("dvChatArea")

    function LoadChat(iTeacherId) {
        debugger;
        document.getElementById("dvChatArea").innerText = '';
        iTo = iTeacherId;

        var url = "@Url.Action("LoadChat", "Teacher")";
        $.ajax({
            url: url,
            cache: false,
            type: "Get",
            dataType: "json",
            data: {
                iTo: iTo
            },
            success: function (data) {
                debugger
                successLoadChat(true, data);
            }
        });
    }

    function successLoadChat(bSuccess, data) {
        debugger;
        for (var iChatRow = 0; iChatRow < data.length; iChatRow++) {
            var lblMsg = document.createElement('label');
            if (data[iChatRow].ID != iRegId) {
                lblMsg.style.textAlign = "right";
            }
            lblMsg.textContent = data[iChatRow].Name;
            dvChatArea.appendChild(lblMsg)
        }
    }


    //SAVING
    function Send() {
        debugger;
        var txtMessage = undefined;

        var oChatting = {};
        oChatting.iUserIdFrom = 1;
        oChatting.iUserIdTo = iTo;
        oChatting.iChattingTime = 0; // new Date();
        txtMessage = document.getElementById("txtMessage");
        oChatting.sMessage = txtMessage.value;

        var url = "@Url.Action("SaveChat", "Teacher")";
        $.ajax({
            url: url,
            cache: false,
            type: "POST",
            dataType: "json",
            data: {
                oChatting: oChatting
            },
            success: function (data) {
                debugger
                successSend(true, data);
            }
        });
    }

    function successSend(bSuccess, data) {
        if (data.iStatus > 0) {
            COMMONMETHODS.ShowToastAsAlert("Saved");
            ResetAndAddMessage()
        }
        else {
            COMMONMETHODS.ShowToastAsAlert("Failed");
        }
    }
    function ResetAndAddMessage() {
        var sMessage = '';

        var txtMessage = document.getElementById("txtMessage");
        if (txtMessage != null && txtMessage != undefined) {
            sMessage = txtMessage.value;


            var lblMsg = document.createElement('label');
            lblMsg.textContent = sMessage;
            dvChatArea.appendChild(lblMsg)
            txtMessage.value = '';
        }
    }
</script>
