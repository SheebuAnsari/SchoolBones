@using SchoolBones
@using SchoolBones.DataStructs
@using SchoolBones.Enums
@using SchoolBones.Common

@model IdValuePair

@{
    string sPopupId = "popup";
    string popupTitle = "";
    IdValuePair popupData = null;
    AdmissionDetails oAdmissionDetails = null;
    Subject oSubject = null;
    List<StudentAttendance> lstStudent = null;

    TeacherDetails oTeacherDetails = null;

    popupData = Model;

    if (popupData != null)
    {
        if (popupData.Id == (int)PopupName.EditTeacherDetails)
        {
            sPopupId += (PopupName)popupData.Id;
            popupTitle = "Edit Teacher Details";
            oTeacherDetails = (TeacherDetails)popupData.Value;
        }


        if (popupData.Id == (int)PopupName.EditStudent)
        {
            sPopupId += (PopupName)popupData.Id;
            popupTitle = "Edit Student";
            oAdmissionDetails = (AdmissionDetails)popupData.Value;
        }
        else if (popupData.Id == (int)PopupName.AddSubject)
        {
            sPopupId += (PopupName)popupData.Id;
            popupTitle = "Add Subject";
            oSubject = (Subject)popupData.Value;
        }
        else if (popupData.Id == (int)PopupName.TakeStudentAttendance)
        {
            sPopupId += (PopupName)popupData.Id;
            popupTitle = "Take Student Attendance";
            lstStudent = (List<StudentAttendance>)popupData.Value;
        }
    }
}



<div class="modal fade right" id="@sPopupId" data-bs-backdrop="static" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">@popupTitle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form>
                    @{
                        //Admin
                        if (popupData.Id == (int)PopupName.EditTeacherDetails)
                        {
                            <div class="form-group" style="display:none">
                                <label class="control-label">Mobile</label>
                                <input id="txtId" type="text" class="form-control" value="@oTeacherDetails.TeacherId" readonly />
                            </div>

                            <div class="form-group">
                                <label class="control-label">Mobile</label>
                                <input id="txtMobile" type="text" class="form-control" value="@oTeacherDetails.Mobile" />
                            </div>

                            <div class="form-group">
                                <label class="control-label">Email</label>
                                <input id="txtEmail" type="text" class="form-control" value="@oTeacherDetails.Email" />
                            </div>

                            <div class="form-group">
                                <label class="control-label">Password</label>
                                <input id="txtPassword" type="text" class="form-control" value="@oTeacherDetails.Password" readonly />
                            </div>

                            <div class="form-group">
                                <label class="control-label">Teacher Name</label>
                                <input id="txtName" type="text" class="form-control" value="@oTeacherDetails.Name" />
                            </div>

                            <div class="form-group">
                                <label class="control-label">Qualification</label>
                                <input id="txtQualification" type="text" class="form-control" value="@oTeacherDetails.Qualification" />
                            </div>

                            <div class="form-group">
                                <label class="control-label">JoiningDate</label>
                                <input id="txtJoinDate" type="text" class="form-control" value="@oTeacherDetails.JoiningDate" />
                            </div>

                            <div class="form-group">
                                <label class="control-label">Package</label>
                                <input id="txtPackage" type="number" class="form-control" value="@oTeacherDetails.Package" />
                            </div>

                            <div class="form-group">
                                <label class="control-label">MonthlySalary</label>
                                <input id="txtMonthlySalary" type="number" class="form-control" value="@oTeacherDetails.MonthlySalary" />
                            </div>

                            <div class="form-group">
                                <label class="control-label">Experiance</label>
                                <input id="txtExp" type="text" class="form-control" value="@oTeacherDetails.Experiance" />
                            </div>
                        }

                        //Teacher
                        if (popupData.Id == (int)PopupName.EditStudent)
                        {
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">Enrollment No</label>
                                <input id="txtEnrollmentNo" type="text" class="form-control" value="@oAdmissionDetails.iEnrollmentNo" readonly>
                            </div>

                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">Name:</label>
                                <input id="txtStdName" type="text" class="form-control" value="@oAdmissionDetails.StdName">
                            </div>

                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">Address</label>
                                <input id="txtAddress" type="text" class="form-control" value="@oAdmissionDetails.Address">
                            </div>

                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">City</label>
                                <input id="txtCity" type="text" class="form-control" value="@oAdmissionDetails.City">
                            </div>

                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">Contact</label>
                                <input id="txtContact" type="text" class="form-control" value="@oAdmissionDetails.Contact">
                            </div>

                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">AdmissionInClass</label>
                                <input id="txtAdmissionInClass" type="text" class="form-control" value="@oAdmissionDetails.AdmissionInClass">
                            </div>

                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">DOB</label>
                                <input id="txtDOB" type="text" class="form-control" value="@oAdmissionDetails.DOB">
                            </div>

                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">Admission Date</label>
                                @*<input id="txtAdmissionDate" type="text" class="form-control" value="@oAdmissionDetails.AdmissionDate">*@
                                <input id="txtAdmissionDate" type="date" class="form-control" placeholder="yyyy-mm-dd" min="2023-01-01" max="2023-12-31" value="@oAdmissionDetails.AdmissionDate" />
                            </div>

                            <div class="mb-3">
                                <label class="form-check-label" for="flexCheckChecked">
                                    <input class="form-check-input" type="checkbox" value="" id="chkIsActive" checked="@oAdmissionDetails.IsActive">
                                    Active
                                </label>
                            </div>
                        }
                        else if (popupData.Id == (int)PopupName.AddSubject)
                        {
                            string sSub = oSubject.SubjectName;
                            <input type="hidden" id="hdnClass" value="@oSubject.Class" />
                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">Subject Name</label>
                                <input id="txtSubjectName" type="text" class="form-control" value="@sSub">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="chkIsDefaultSubject">
                                    <label class="form-check-label" for="flexCheckChecked">
                                        DefaultSubject
                                    </label>
                                </div>
                            </div>
                        }
                        else if (popupData.Id == (int)PopupName.TakeStudentAttendance)
                        {
                            <div class="row">
                                <label id="lblDateOfAttendance"></label>
                            </div>
                            <hr />
                            <table class="ReportTable">
                                <thead>
                                    <tr>
                                        <th>Roll no</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="">
                                    @{ 
                                        if (lstStudent != null && lstStudent.Count > 0)
                                        {
                                            for (int iStd = 0; iStd < lstStudent.Count; iStd++)
                                            {
                                                <tr>
                                                    <td>@lstStudent[iStd].StdId</td>
                                                    <td>@lstStudent[iStd].StdName</td>
                                                    <td>
                                                        <input type="checkbox" onclick="AttandenceOfStudents(this)" id="@lstStudent[iStd].StdId"/>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                    <tr>
                                        
                                    </tr>
                                </tbody>
                            </table>
                                        }
                    }
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                @{
                    if (popupData.Id == (int)PopupName.EditStudent)
                    {
                        <button type="button" class="btn btn-primary" onclick="SaveChanges()">Save</button>
                    }
                    else if (popupData.Id == (int)PopupName.AddSubject)
                    {
                        if (oSubject.SubjectId > 0)
                        {
                            <button type="button" class="btn btn-primary" onclick="UpdateSubject(@oSubject.SubjectId, @((int)ActionType.Update))">Update</button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-primary" onclick="SaveSubject()">Save</button>
                        }
                    }
                    else if (popupData.Id == (int)PopupName.TakeStudentAttendance)
                    {
                        <button type="button" class="btn btn-primary" onclick="SaveAttandence()">Save</button>
                    }
                }
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        if(document.getElementById("dtAttendaneDate") != null){
            document.getElementById("lblDateOfAttendance").innerText = "Date of Attendance : "+ document.getElementById("dtAttendaneDate").value;
        }
    });

    var oSubject = @Html.Raw(Json.Encode(oSubject));
    var lstStudent = @Html.Raw(Json.Encode(lstStudent));

    function SaveSubject() {
        debugger
        var oSubject = {};
        oSubject.Class = parseInt(document.getElementById("hdnClass").value);
        oSubject.SubjectName = document.getElementById("txtSubjectName").value;
        oSubject.IsDefaultSubject = document.getElementById("chkIsDefaultSubject").checked;


        var url = "@Url.Action("AddSubject", "Teacher")";
        $.ajax({
            url: url,
            cache: false,
            type: "POST",
            dataType: "json",
            data: {
                oSubject: oSubject
            },
            success: function (data) {
                successSaveSubject(true, data);
            }
        });
    }
    function successSaveSubject(bSuccess, data){
        if(data.iStatus>0){
            COMMONMETHODS.ShowToastAsAlert("Saved");
            LoadSubjects();
        }else{
            COMMONMETHODS.ShowToastAsAlert("!Saved");
        }
    }

    function SaveChanges() {
        debugger;

        var txtEnrollmentNo = document.getElementById("txtEnrollmentNo");
        var txtStdName = document.getElementById("txtStdName");
        var txtFirstName = document.getElementById("txtFirstName");
        var txtLastName = document.getElementById("txtLastName");
        var txtAddress = document.getElementById("txtAddress");
        var txtCity = document.getElementById("txtCity");
        var txtContact = document.getElementById("txtContact");
        var txtAdmissionInClass = document.getElementById("txtAdmissionInClass");
        var txtDOB = document.getElementById("txtDOB");
        var chkIsActive = document.getElementById("chkIsActive");
        //var txtAdmissionDate = document.getElementById("txtAdmissionDate");
        var sSelectedDate = document.getElementById("txtAdmissionDate").value;
        var iAdmissionDate = FDate.convertDateToInt(sSelectedDate, "yyyy-mm-dd", 0);



        var oAdmissionDetails = {};
        oAdmissionDetails.iEnrollmentNo = txtEnrollmentNo.value;
        oAdmissionDetails.StdName = txtStdName.value;
        oAdmissionDetails.FirstName = txtFirstName.value;
        oAdmissionDetails.LastName = txtLastName.value;
        oAdmissionDetails.Address = txtAddress.value;
        oAdmissionDetails.City = txtCity.value;
        oAdmissionDetails.Contact = parseInt(txtContact.value);
        oAdmissionDetails.AdmissionInClass = parseInt(txtAdmissionInClass.value);
        oAdmissionDetails.DOB = parseInt(txtDOB.value);
        oAdmissionDetails.IsActive = chkIsActive.checked;
        oAdmissionDetails.AdmissionDate = iAdmissionDate;

        var url = "@Url.Action("StudentAdmission", "Teacher")";
        $.ajax({
            url: url,
            cache: false,
            type: "POST",
            dataType: "json",
            data: {
                oAdmissionDetails: oAdmissionDetails
            },
            success: function (data) {
                debugger
                successStudentAdmission(true, data);
            }
        });
    }
    function successStudentAdmission(bSuccess, data) {
        debugger;
        if (data.iStatus > 0) {
            COMMONMETHODS.ShowToastAsAlert("Updated");
        } else {
            COMMONMETHODS.ShowToastAsAlert("!Updated");
        }
    }
    function UpdateSubject(iSubjectId, iActionType) {
        debugger;
        var oSubject = {};
        var url = "@Url.Action("DoAction", "Teacher")";
        oSubject.SubjectId = iSubjectId
        oSubject.Class = parseInt(document.getElementById("hdnClass").value);
        oSubject.SubjectName = document.getElementById("txtSubjectName").value;
        $.ajax({
            url: url,
            cache: false,
            type: "POST",
            dataType: "json",
            data: {
                oSubject: oSubject,
                iActionType: iActionType
            },
            success: function (data) {
                debugger;
                successDoAction(true, data);
            }
        });
    }
    function successDoAction(bSuccess, data) {
        if (data.iStatus > 0) {
            COMMONMETHODS.ShowToastAsAlert("Updated");
        } else {
            COMMONMETHODS.ShowToastAsAlert("!Updated");
        }
    }
    //Attendance of Std
    var arrStdIds=[];

    function AttandenceOfStudents(ele){
        debugger;
        var iStdId = ele.id;
        if(ele.checked){
            arrStdIds.push(iStdId);
        }else{
            var iIndex = arrStdIds.indexOf(iStdId);
            arrStdIds.splice(iIndex);
        }
    }
    function SaveAttandence(){
        debugger;
        var iStdId = 0;
        var iAttDate = 0;
        lstAttandence =[];
        
        var sSelectedDate = document.getElementById("dtAttendaneDate").value;

        //if(lstAttandence.length == 0)
        {
            for (var iRow = 0; iRow < lstStudent.length; iRow++){
                iStdId = lstStudent[iRow].StdId;
                for (var iId = 0; iId < arrStdIds.length; iId++) {
                    if(iStdId == arrStdIds[iId]){
                        lstAttandence.push({
                            StdId:lstStudent[iRow].StdId,
                            StdName:lstStudent[iRow].StdName,
                            Class:lstStudent[iRow].Class,
                            Date :lstStudent[iRow].Date,
                            Status :1
                        });
                    }
                }
            }
        }

        var url = "@Url.Action("SaveAttandence", "Teacher")";
        $.ajax({
            url: url,
            cache: false,
            type: "POST",
            dataType: "json",
            data: {
                arrStudentAttandence: lstAttandence,
                iDate: FDate.convertDateToInt(sSelectedDate, "yyyy-mm-dd", 0),
            },
            success: function (data) {
                successSaveAttandence(true, data);
            }
        });
    }
    function successSaveAttandence(bSuccess, data){
        if(bSuccess){
            if(data.iStatus>0){
                COMMONMETHODS.ShowToastAsAlert("Saved.")
            }else{
                COMMONMETHODS.ShowToastAsAlert("failed.")
            }
        }
    }
    //
</script>